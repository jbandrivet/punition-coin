<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Punition</title>
  <style>
    body {
      background: #c0c0c0;
      font-family: "MS Sans Serif","Tahoma",sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      margin: 0;
      color: #000;
    }
    h1 {
      background: #000080;
      color: #fff;
      padding: 6px 10px;
      font-size: 18px;
      margin: 0 0 10px 0;
      width: 100%;
      max-width: 720px;
      text-align: left;
    }
    .explanation {
      background: #e0e0e0;
      border: 2px solid #fff;
      border-right-color: #808080;
      border-bottom-color: #808080;
      padding: 10px;
      margin-bottom: 18px;
      width: 100%;
      max-width: 720px;
      font-size: 14px;
    }
    .controls {
      background: #f0f0f0;
      border: 2px solid #fff;
      border-right-color: #808080;
      border-bottom-color: #808080;
      padding: 12px;
      width: 100%;
      max-width: 720px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    label { font-size: 13px; margin-bottom: 4px; display:block; }
    input[type="text"] {
      padding: 6px;
      border: 2px solid #fff;
      border-right-color: #808080;
      border-bottom-color: #808080;
      background: #cfcfcf;
      font-family: inherit;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    .row { display:flex; gap:10px; align-items:center; }
    .small { width: 160px; }
    .btn {
      background: #c0c0c0;
      border: 2px solid #fff;
      border-right-color: #808080;
      border-bottom-color: #808080;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:active {
      border: 2px solid #808080;
      border-right-color: #fff;
      border-bottom-color: #fff;
    }
    .status { font-size: 14px; margin-top: 6px; }
    .timer { font-size: 36px; margin: 12px 0; text-align:center; }
    #resultBox { display:none; margin-top:10px; border-top:1px solid #808080; padding-top:8px; }
    .note { font-size:12px; color:#333; margin-top:6px; }
    .savedNumber { font-weight:bold; }
    .error { color: #b00000; font-size: 13px; }
    .wakelock-status {
      font-size: 12px;
      color: #006600;
      margin-top: 4px;
      display: none;
    }
    .wakelock-status.active {
      display: block;
    }
    .footer {
      margin-top: 20px;
      font-size: 11px;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Punition au coin - Programme d'entra√Ænement</h1>

  <div class="explanation">
    <p>üìå <strong>√Ä quoi √ßa sert :</strong><br>
    Ce programme simule un temps de concentration (punition ¬´ au coin ¬ª). Il mesure une dur√©e al√©atoire (2‚Äì10 minutes) et envoie le r√©sultat par WhatsApp au num√©ro fran√ßais saisi.</p>

    <p>‚öôÔ∏è <strong>Comment √ßa fonctionne :</strong><br>
    ‚Ä¢ Entrez un num√©ro de t√©l√©phone fran√ßais puis cliquez <em>Enregistrer le num√©ro</em>.<br>
    ‚Ä¢ Cliquez sur <em>Commencer</em> : une dur√©e secr√®te d√©marre.<br>
    ‚Ä¢ L'√©cran affiche <code>??:??</code> jusqu'√† la fin.<br>
    ‚Ä¢ Quand le temps est fini : 5 ding m√©talliques.<br>
    ‚Ä¢ Choisissez <em>R√©ussi</em> ou <em>√âchou√©</em>, puis le r√©sultat est envoy√© sur WhatsApp.<br>
    ‚Ä¢ üîí L'√©cran reste actif pendant toute la punition (anti-veille automatique).</p>
  </div>

  <div class="controls">
    <div>
      <label for="phoneInput">Num√©ro fran√ßais (ex. 07XXXXXXXX ou +337XXXXXXXX)</label>
      <input id="phoneInput" type="text" placeholder="07XXXXXXXX ou +337XXXXXXXX"/>
      <div class="row">
        <button id="saveBtn" class="btn small" onclick="saveNumber()">Enregistrer le num√©ro</button>
        <div id="savedDisplay" style="margin-left:6px;">Aucun num√©ro enregistr√©</div>
      </div>
      <div id="phoneError" class="error"></div>
      <div class="note">Seuls les num√©ros fran√ßais (commen√ßant par 0 ou +33) sont accept√©s.</div>
    </div>

    <div style="border-top:1px solid #d0d0d0; padding-top:8px;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div class="status" id="status">Pr√™t √† commencer...</div>
          <div class="wakelock-status" id="wakelockStatus">üîí √âcran maintenu actif</div>
          <div class="timer" id="timerDisplay">--:--</div>
        </div>
        <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
          <button id="startBtn" class="btn" onclick="startPunishment()" disabled>Commencer</button>
          <button id="stopBtn" class="btn" onclick="stopPunishment()" style="display:none;">Arr√™ter</button>
        </div>
      </div>

      <div id="resultBox">
        <p>R√©sultat de la punition :</p>
        <div class="row">
          <button class="btn" onclick="sendResult(true)">‚úÖ R√©ussi</button>
          <button class="btn" onclick="sendResult(false)">‚ùå √âchou√©</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    Punition Trainer v1.1 ‚Äî üîí Anti-veille int√©gr√©
  </div>

<script>
  let timeLeft, totalTime, timerId, isRunning = false;
  let startTime, endTime;
  let audioContext;
  let waNumber = null;
  let wakeLock = null;

  const phoneInput = document.getElementById('phoneInput');
  const phoneError = document.getElementById('phoneError');
  const savedDisplay = document.getElementById('savedDisplay');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const wakelockStatus = document.getElementById('wakelockStatus');

  function normalizeFrenchNumber(input) {
    if (!input) return null;
    let s = input.trim().replace(/[\s\-().]/g, '');
    // Format +33
    if (s.startsWith('+33')) {
      const rest = s.slice(3);
      if (/^[1-9]\d{8}$/.test(rest)) return '33' + rest;
      return null;
    }
    // Format 0X (national)
    if (/^0[1-9]\d{8}$/.test(s)) {
      return '33' + s.slice(1);
    }
    return null;
  }

  function saveNumber() {
    phoneError.textContent = '';
    const norm = normalizeFrenchNumber(phoneInput.value);
    if (!norm) {
      phoneError.textContent = 'Num√©ro invalide ‚Äî entrez un num√©ro fran√ßais valide.';
      waNumber = null;
      savedDisplay.textContent = 'Aucun num√©ro enregistr√©';
      startBtn.disabled = true;
      return;
    }
    waNumber = norm;
    savedDisplay.innerHTML = 'Num√©ro enregistr√© : <span class="savedNumber">+'
      + waNumber + '</span>';
    startBtn.disabled = false;
  }

  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock released');
        });
        wakelockStatus.classList.add('active');
      } else {
        console.warn('Wake Lock API not supported');
      }
    } catch (err) {
      console.error('Wake Lock error:', err);
    }
  }

  function releaseWakeLock() {
    if (wakeLock) {
      wakeLock.release();
      wakeLock = null;
      wakelockStatus.classList.remove('active');
    }
  }

  async function startPunishment() {
    if (isRunning || !waNumber) return;
    const minutes = Math.floor(Math.random() * 9) + 2; // 2 √† 10
    totalTime = minutes * 60;
    timeLeft = totalTime;
    isRunning = true;
    startTime = new Date();

    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

    await requestWakeLock();

    document.getElementById('status').textContent = '‚ö†Ô∏è Punition en cours...';
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    updateTimerDisplay();

    timerId = setInterval(() => {
      timeLeft--;
      updateTimerDisplay();
      if (timeLeft <= 0) finishPunishment();
    }, 1000);
  }

  function updateTimerDisplay() {
    document.getElementById('timerDisplay').textContent = '??:??';
  }

  function finishPunishment() {
    clearInterval(timerId);
    isRunning = false;
    endTime = new Date();

    releaseWakeLock();

    document.getElementById('status').textContent = '‚úÖ Punition termin√©e !';
    stopBtn.style.display = 'none';
    startBtn.style.display = 'inline-block';
    document.getElementById('timerDisplay').textContent = '00:00';

    playMetallicDings(5);
    document.getElementById('resultBox').style.display = 'block';
  }

  function stopPunishment() {
    clearInterval(timerId);
    isRunning = false;
    releaseWakeLock();
    document.getElementById('status').textContent = '‚ùå Punition annul√©e';
    document.getElementById('timerDisplay').textContent = '--:--';
    stopBtn.style.display = 'none';
    startBtn.style.display = 'inline-block';
    document.getElementById('resultBox').style.display = 'none';
  }

  function formatTime(d) {
    return d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
  }

  function sendResult(success) {
    if (!waNumber) {
      phoneError.textContent = 'Num√©ro manquant ‚Äî impossible d'envoyer le message.';
      return;
    }
    const durationMin = Math.round(totalTime / 60);
    const resultText = success ? 'R√©ussi ‚úÖ' : '√âchou√© ‚ùå';
    const msg = `Punition termin√©e !\nHeure de d√©but : ${formatTime(startTime)}\nHeure de fin : ${formatTime(endTime)}\nDur√©e : ${durationMin} minutes\nR√©sultat : ${resultText}`;
    const url = `https://wa.me/${waNumber}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
  }

  function playMetallicDings(count) {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    for (let i = 0; i < count; i++) {
      setTimeout(() => {
        const now = audioContext.currentTime;
        const osc = audioContext.createOscillator();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(440, now);
        const gain = audioContext.createGain();
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.start(now);
        osc.stop(now + 0.6);
      }, i * 600);
    }
  }

  document.addEventListener('click', function initAudio() {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    document.removeEventListener('click', initAudio);
  });

  // R√©activer le Wake Lock si l'utilisateur revient sur la page
  document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible' && isRunning) {
      await requestWakeLock();
    }
  });

  phoneInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') saveNumber();
  });
</script>
</body>
</html>
